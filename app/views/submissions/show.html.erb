<% content_for :title, "Showing submission" %>

<div class="form-card">
  <h1 class="font-bold text-4xl mb-6">Showing submission</h1>

  <%= render @submission %>

  <% if @submission.worklogs.count > 0 %>
    <div class="flex form-card">
      <%= pie_chart @project_hours, donut: true, height: "250px", colors: ["#4F46E5", "#22C55E", "#F59E0B", "#EF4444"] %>
      <%= column_chart @worklogs_by_day, 
                      xtitle: "Date", 
                      ytitle: "Hours", 
                      colors: ["#4F46E5"], 
                      height: "300px" %>
    </div>

    <%= render "shared/worklogs_table", worklogs: @worklogs %>

  <% else %>
    <p class="justify-center py-4"><%= "Worklogs were rejected: #{@submission.updated_at}" %></p>
  <% end %>

  <div id="submission_actions" class="flex gap-x-3 pt-6">
    <%= back_button %>
    
    <% if @submission.draft? && current_user_admin? %>
      <%= button_to "Approve", approve_submission_path(@submission), method: :patch, class: "button-success" %>
      
      <%= render "rejection_modal", submission: @submission %>
    <% end %>
  </div>
  
  <div class="mt-6 gap-3">
    <% if @submission.approved? && @submission.worklogs.any? %>
      <details class="group">
        
        <summary class="list-none [&::-webkit-details-marker]:hidden cursor-pointer text-indigo-500 dark:text-green-400 font-bold hover:underline mb-4 flex items-center gap-2 select-none">
          
          <span>Export options</span>
          
          <svg class="w-4 h-4 transition-transform duration-200 group-open:rotate-90" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
          </svg>
          
        </summary>

        <div class="space-y-4 p-4 border border-zinc-200 dark:border-zinc-700 rounded-lg bg-zinc-50/50 dark:bg-zinc-100/50">
          
          <div class="flex items-center gap-4">
            <span class="font-bold text-body w-28">Export CSV:</span>
            <div class="flex gap-2">
              <%= link_to "All (CSV)", 
                export_submission_path(@submission, format: :csv),
                class: "button-success" %>

              <% @projects.each do |project| %>
              <%= link_to "#{project.name} (CSV)",
                    export_submission_path(@submission, format: :csv, project_id: project.id),
                    class: "button" %>
              <% end %>
              </div>
          </div>

          <div class="flex items-center gap-4">
            <span class="font-bold text-body w-28">Export XLSX:</span>
            <div class="flex gap-2">
              <%= link_to "All (XLSX)", 
                    export_submission_path(@submission, format: :xlsx),
                    class: "button-success" %>
              
              <%# 2. Dynamic project-specific buttons %>
              <% @projects.each do |project| %>
                <%= link_to "#{project.name} (XLSX)",
                      export_submission_path(@submission, format: :xlsx, project_id: project.id),
                      class: "button" %>
              <% end %>
              </div>
          </div>
        </div>
      </details>
    <% end %>
  </div>
</div>
