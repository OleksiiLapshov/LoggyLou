<% content_for :title, "Showing submission" %>

<div class="form-card">
  <h1 class="font-bold text-4xl mb-6">Showing submission</h1>

  <%= render @submission %>

  <% if @submission.worklogs.count > 0 %>
    <div class="flex form-card">
      <%= pie_chart @project_hours, donut: true, height: "250px", colors: ["#4F46E5", "#22C55E", "#F59E0B", "#EF4444"] %>
      <%= column_chart @worklogs_by_day, 
                      xtitle: "Date", 
                      ytitle: "Hours", 
                      colors: ["#4F46E5"], 
                      height: "300px" %>
    </div>

    <%= render "shared/worklogs_table", worklogs: @worklogs %>

  <% else %>
    <p class="justify-center py-4"><%= "Worklogs were rejected: #{@submission.updated_at}" %></p>
  <% end %>

  <div class="flex gap-x-3 pt-6">
    <%= link_to "Back to submissions", submissions_path( {month: params[:month], year: params[:year]}.compact_blank ), class: "button-secondary" %>
    <% if @submission.draft? && current_user_admin? %>
      <%= button_to "Approve", approve_submission_path(@submission),
                    method: :patch,
                    class: "bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700" %>
      <%= button_tag "Reject",
                    type: "button",
                    id: "reject-btn",
                    class: "bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700" %>
    <% end %>
  </div>
  <div class="mt-6 gap-3">
    <% if @submission.approved? && @submission.worklogs.any? %>
      <details class="group">
        
        <summary class="list-none [&::-webkit-details-marker]:hidden cursor-pointer text-indigo-500 dark:text-green-400 font-bold hover:underline mb-4 flex items-center gap-2 select-none">
          
          <span>Export options</span>
          
          <svg class="w-4 h-4 transition-transform duration-200 group-open:rotate-90" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
          </svg>
          
        </summary>

        <div class="space-y-4 p-4 border border-zinc-200 dark:border-zinc-700 rounded-lg bg-zinc-50/50 dark:bg-zinc-100/50">
          
          <div class="flex items-center gap-4">
            <span class="font-bold text-body w-28">Export CSV:</span>
            <div class="flex gap-2">
              <%= link_to "All (CSV)", 
                export_submission_path(@submission, format: :csv),
                class: "button-success" %>

              <% @projects.each do |project| %>
              <%= link_to "#{project.name} (CSV)",
                    export_submission_path(@submission, format: :csv, project_id: project.id),
                    class: "button" %>
              <% end %>
              </div>
          </div>

          <div class="flex items-center gap-4">
            <span class="font-bold text-body w-28">Export XLSX:</span>
            <div class="flex gap-2">
              <%= link_to "All (XLSX)", 
                    export_submission_path(@submission, format: :xlsx),
                    class: "button-success" %>
              
              <%# 2. Dynamic project-specific buttons %>
              <% @projects.each do |project| %>
                <%= link_to "#{project.name} (XLSX)",
                      export_submission_path(@submission, format: :xlsx, project_id: project.id),
                      class: "button" %>
              <% end %>
              </div>
          </div>
        </div>
      </details>
    <% end %>
  </div>
</div>

<!-- Rejection Modal -->
<div id="rejection-modal"
     class="hidden fixed inset-0 bg-gray-700/90 flex items-center justify-center z-50">
  <div class="bg-white rounded-xl p-6 w-96">
    <h2 class="text-lg font-bold mb-4">Reject Submission</h2>
    <%= form_with url: reject_submission_path(@submission), method: :patch do |f| %>
      <%= f.label :note, "Reason for rejection", class: "block mb-2" %>
      <%= f.text_area :note, required: true, class: "w-full border rounded p-2 mb-4" %>
      <div class="flex justify-end gap-2">
        <button type="button" id="cancel-reject" class="bg-gray-300 px-3 py-1 rounded">Cancel</button>
        <%= f.submit "Reject", class: "bg-red-600 text-white px-3 py-1 rounded hover:bg-red-700" %>
      </div>
    <% end %>
  </div>
</div>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    const modal = document.getElementById("rejection-modal");
    const openBtn = document.getElementById("reject-btn");
    const cancelBtn = document.getElementById("cancel-reject");

    if (openBtn) openBtn.addEventListener("click", () => modal.classList.remove("hidden"));
    if (cancelBtn) cancelBtn.addEventListener("click", () => modal.classList.add("hidden"));
  });
</script>