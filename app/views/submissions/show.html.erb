<% content_for :title, "Showing submission" %>

<div class="form-card">
  <h1 class="font-bold text-4xl mb-6">Showing submission</h1>

  <%= render @submission %>

  <% if @submission.worklogs.count > 0 %>
    <div class="flex">
      <%= pie_chart @project_hours, donut: true, height: "250px", colors: ["#4F46E5", "#22C55E", "#F59E0B", "#EF4444"] %>
      <%= column_chart @worklogs_by_day, 
                      xtitle: "Date", 
                      ytitle: "Hours", 
                      colors: ["#4F46E5"], 
                      height: "300px" %>
    </div>
    <table class="table-fixed w-full border border-zinc-500 border-collapse my-6">
      <thead class="text-lf font-bold">
        <tr>
          <td class="border border-zinc-500 py-2 px-3 w-32">Date</td>
          <td class="border border-zinc-500 py-2 px-3 w-32">Employee</td>
          <td class="border border-zinc-500 py-2 px-3 w-18">Hours</td>
          <td class="border border-zinc-500 py-2 px-3 w-48">Project</td>
          <td class="border border-zinc-500 py-2 px-3">Notes</td>
        </tr>
      </thead>
        <tbody>
          <% @submission.worklogs.each do |worklog| %>
            <tr>
              <td class="border border-zinc-500 py-2 px-3"><%= worklog.log_date %></td>
              <td class="border border-zinc-500 py-2 px-3"><%= worklog.user.full_name %></td>
              <td class="border border-zinc-500 py-2 px-3"><%= worklog.hours %></td>
              <td class="border border-zinc-500 py-2 px-3"><%= worklog.project.name %></td>
              <td class="border border-zinc-500 py-2 px-3" title="<%= worklog.note %>"><%= truncate(worklog.note, length: 100) %></td>
            </tr>
          <% end %>
        </tbody>
    </table>
  <% else %>
    <p class="justify-center py-4"><%= "Worklogs were rejected: #{@submission.updated_at}" %></p>
  <% end %>

  <div class="flex gap-x-3">
    <%= link_to "Back to submissions", submissions_path( {month: params[:month], year: params[:year]}.compact_blank ), class: "button-secondary" %>
    <% if @submission.draft? && current_user_admin? %>
      <%= button_to "Approve", approve_submission_path(@submission),
                    method: :patch,
                    class: "bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700" %>
      <%= button_tag "Reject",
                    type: "button",
                    id: "reject-btn",
                    class: "bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700" %>
    <% end %>
    <% if @submission.approved? && @submission.worklogs.any? %>
      <div class"flex flex-wrap gap-2 items-center">
        <span class="font-bold">Export:</span>
        
        <%# 1. The "Export All" button %>
        <%= link_to "All (CSV)", 
              export_submission_path(@submission, format: :csv),
              class: "button-success" %>
        
        <%# 2. Dynamic project-specific buttons %>
        <% @projects.each do |project| %>
          <%= link_to "#{project.name} (CSV)",
                export_submission_path(@submission, format: :csv, project_id: project.id),
                class: "button" %>
        <% end %>
      </div>
    <% end %>
  </div>
</div>

<!-- Rejection Modal -->
<div id="rejection-modal"
     class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50">
  <div class="bg-white rounded-xl p-6 w-96">
    <h2 class="text-lg font-bold mb-4">Reject Submission</h2>
    <%= form_with url: reject_submission_path(@submission), method: :patch do |f| %>
      <%= f.label :note, "Reason for rejection", class: "block mb-2" %>
      <%= f.text_area :note, required: true, class: "w-full border rounded p-2 mb-4" %>
      <div class="flex justify-end gap-2">
        <button type="button" id="cancel-reject" class="bg-gray-300 px-3 py-1 rounded">Cancel</button>
        <%= f.submit "Reject", class: "bg-red-600 text-white px-3 py-1 rounded hover:bg-red-700" %>
      </div>
    <% end %>
  </div>
</div>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    const modal = document.getElementById("rejection-modal");
    const openBtn = document.getElementById("reject-btn");
    const cancelBtn = document.getElementById("cancel-reject");

    if (openBtn) openBtn.addEventListener("click", () => modal.classList.remove("hidden"));
    if (cancelBtn) cancelBtn.addEventListener("click", () => modal.classList.add("hidden"));
  });
</script>