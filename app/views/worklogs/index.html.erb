<% content_for :title, "Worklogs" %>

<div class="form-card">
  <%= form_with url: worklogs_path, method: :get, local: true, class: "flex items-center gap-4" do |form| %>
    <div>
      <%= form.label :month, "Month:", class: "mr-2" %>
      <%= form.select :month, 
            Date::MONTHNAMES.compact.map.with_index(1) { |name, i| [name, i] },
            { selected: @selected_month },
            { class: "border border-zinc-500 rounded px-3 py-2" } %>
    </div>
    <div>
      <%= form.label :year, "Year:", class: "mr-2" %>
      <%= form.select :year, 
          (Date.today.year - 2..Date.today.year + 1).to_a.reverse,
          { selected: @selected_year },
          { class: "border border-zinc-500 rounded px-3 py-2" } %>
    </div>

    <%= form.submit "Filter", class: "button" %>
    <%= link_to "Reset", worklogs_path, class: "button-secondary" %>

    <% if !current_user_admin? %>
      <% if @worklogs.count > 0 %>
        <%= link_to "Export CSV", 
              export_worklogs_path(month: @selected_month, year: @selected_year, format: :csv),
              class: "button-success" %>
      <% end %>

      <% if @unsubmitted.sum(:hours) > 0 %>
        <%= link_to "Submit Timesheet (#{@unsubmitted.sum(:hours)} h)",
              submit_timesheet_worklogs_path(month: @selected_month, year: @selected_year),
              data: { turbo_method: :post,
                turbo_confirm: "Submit #{@unsubmitted.sum(:hours)} hours for #{@first_day.strftime('%B %Y')}?" },
              class: "button-success" %>
      <% end %>
    <% end %>
  <% end %>
</div>

<% if !current_user_admin? %>
  <div class="form-card">
    <h1 class="h1-style">My Worklogs</h1>

    <%= column_chart @worklogs_by_day, 
                      xtitle: "Date", 
                      ytitle: "Hours", 
                      colors: ["#4F46E5"], 
                      height: "200px" %>

    <section class="my-6">
      <%= link_to "New worklog", new_worklog_path, class: "button-success" %>
    </section>
    <table class="table-fixed w-full border border-zinc-500 border-collapse">
    <thead class="text-lf font-bold">
      <tr>
        <td class="border border-zinc-500 py-2 px-3 w-32">Date</td>
        <td class="border border-zinc-500 py-2 px-3 w-18">Hours</td>
        <td class="border border-zinc-500 py-2 px-3 w-48">Project</td>
        <td class="border border-zinc-500 py-2 px-3">Notes</td>
        <td class="border border-zinc-500 py-2 px-3 w-48">Actions</td>
      </tr>
    </thead>
      <tbody>
        <% @worklogs.each do |worklog| %>
          <tr>
            <td class="border border-zinc-500 py-2 px-3"><%= worklog.log_date%></td>
            <td class="border border-zinc-500 py-2 px-3"><%= worklog.hours %></td>
            <td class="border border-zinc-500 py-2 px-3"><%= worklog.project.name %></td>
            <td class="border border-zinc-500 py-2 px-3" title="<%= worklog.note %>"><%= truncate(worklog.note, length: 100) %></td>
            <td class="border border-zinc-500 py-2 px-3">
              <div class="flex gap-1 justify-center">
                <%= button_to "View", worklog,
                              method: :get,
                              class: "button-secondary"%>
                <%= button_to "Edit", edit_worklog_path(worklog),
                              method: :get,
                              class: worklog.editable? ? "button" : "button-disabled", 
                              disabled: !worklog.editable? %>
              </div>
            </td>
          </tr>
        <% end %>
      </tbody>
    </table>
    <section class="mt-6">
      <%= link_to "New worklog", new_worklog_path, class: "button-success" %>
    </section>
  </div>
<% end %>

<% if current_user_admin? %>
  <div class="form-card">
    <h1 class="h1-style">Employee's Worklogs</h1>

    <table class="table-fixed w-full border border-zinc-500 border-collapse">
    <thead class="text-lf font-bold">
      <tr>
        <td class="border border-zinc-500 py-2 px-3 w-32">Date</td>
        <td class="border border-zinc-500 py-2 px-3 w-32">Employee</td>
        <td class="border border-zinc-500 py-2 px-3 w-18">Hours</td>
        <td class="border border-zinc-500 py-2 px-3 w-48">Project</td>
        <td class="border border-zinc-500 py-2 px-3">Notes</td>
      </tr>
    </thead>
      <tbody>
        <% @worklogs.each do |worklog| %>
          <tr>
            <td class="border border-zinc-500 py-2 px-3"><%= worklog.log_date %></td>
            <td class="border border-zinc-500 py-2 px-3"><%= worklog.user.full_name %></td>
            <td class="border border-zinc-500 py-2 px-3"><%= worklog.hours %></td>
            <td class="border border-zinc-500 py-2 px-3"><%= worklog.project.name %></td>
            <td class="border border-zinc-500 py-2 px-3" title="<%= worklog.note %>"><%= truncate(worklog.note, length: 100) %></td>
          </tr>
        <% end %>
      </tbody>
    </table>
  </div>
<% end %>

