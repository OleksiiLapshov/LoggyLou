<% content_for :title, "Worklogs" %>

<div class="form-card">
  <%= form_with url: worklogs_path, method: :get, local: true, class: "flex items-center gap-4" do |form| %>
    <div>
      <%= form.label :month, "Month:", class: "mr-2" %>
      <%= form.select :month, 
            Date::MONTHNAMES.compact.map.with_index(1) { |name, i| [name, i] },
            { selected: @selected_month },
            { class: "border border-zinc-500 rounded px-3 py-2" } %>
    </div>
    <div>
      <%= form.label :year, "Year:", class: "mr-2" %>
      <%= form.select :year, 
          (Date.today.year - 2..Date.today.year + 1).to_a.reverse,
          { selected: @selected_year },
          { class: "border border-zinc-500 rounded px-3 py-2" } %>
    </div>

    <%= form.submit "Filter", class: "button" %>
    <%= link_to "Reset", worklogs_path, class: "button-secondary" %>

    <% if !current_user_admin? %>
      <% if @worklogs.count > 0 %>
        <%= link_to "Export CSV", 
              export_worklogs_path(month: @selected_month, year: @selected_year, format: :csv),
              class: "button-success" %>
        <%= link_to "Export EXCEL", 
              export_worklogs_path(month: @selected_month, year: @selected_year, format: :xlsx),
              class: "button-success" %>
      <% end %>

      <% if @unsubmitted.sum(:hours) > 0 %>
        <%= link_to "Submit Timesheet (#{@unsubmitted.sum(:hours)} h)",
              submit_timesheet_worklogs_path(month: @selected_month, year: @selected_year),
              data: { turbo_method: :post,
                turbo_confirm: "Submit #{@unsubmitted.sum(:hours)} hours for #{@first_day.strftime('%B %Y')}?" },
              class: "button-success" %>
      <% end %>
    <% end %>
  <% end %>
</div>

<div class="form-card">
  <h1 class="h1-style">Worklogs</h1>

  <% if !current_user_admin? %>
    <%= column_chart @worklogs_by_day, 
                      xtitle: "Date", 
                      ytitle: "Hours", 
                      colors: ["#4F46E5"], 
                      height: "200px" %>
  
  <% end %>
  
  <% if !current_user_admin? %>
    <section class="mt-6">
      <%= link_to "New worklog", new_worklog_path, class: "button-success" %>
    </section>
  <% end %>

  <%= render "shared/worklogs_table", worklogs: @worklogs %>

  <% if !current_user_admin? %>
    <section class="mt-6">
      <%= link_to "New worklog", new_worklog_path, class: "button-success" %>
    </section>
  <% end %>
</div>


